{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "Prometheus data source for Istio metrics",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    {
      "type": "datasource",
      "id": "prometheus",
      "name": "Prometheus",
      "version": "1.0.0"
    },
    {
      "type": "grafana",
      "id": "grafana",
      "name": "Grafana",
      "version": "9.0.0"
    }
  ],
  "annotations": { "list": [] },
  "editable": true,
  "id": null,
  "links": [],
  "panels": [
    { "content": "<div class=\"dashboard-header text-center\"><span>RED: $canary.$namespace</span></div>", "gridPos": { "h": 3, "w": 24, "x": 0, "y": 0 }, "id": 89, "mode": "html", "title": "", "transparent": true, "type": "text" },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "ops" } },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 3 },
      "id": 90,
      "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [{ "expr": "round(sum(rate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$primary\"}[2m])), 0.001)", "refId": "A" }],
      "title": "Primary: Incoming Request Volume",
      "type": "stat"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "percentunit" } },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 3 },
      "id": 98,
      "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["avg"] } },
      "targets": [{ "expr": "sum(irate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$primary\",response_code!~\"5.*\"}[2m])) / sum(irate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$primary\"}[2m]))", "refId": "B" }],
      "title": "Incoming Success Rate",
      "type": "stat"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "ops" } },
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 3 },
      "id": 97,
      "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [{ "expr": "round(sum(rate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$canary\"}[2m])), 0.001)", "refId": "A" }],
      "title": "Canary: Incoming Request Volume",
      "type": "stat"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "percentunit" } },
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 3 },
      "id": 99,
      "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [{ "expr": "sum(irate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$canary\",response_code!~\"5.*\"}[2m])) / sum(irate(istio_requests_total{reporter=\"destination\",destination_workload_namespace=~\"$namespace\",destination_workload=~\"$canary\"}[2m]))", "refId": "B" }],
      "title": "Incoming Success Rate",
      "type": "stat"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "s" } },
      "gridPos": { "h": 4, "w": 12, "x": 0, "y": 7 },
      "id": 96,
      "options": { "legend": { "displayMode": "list", "showLegend": false } },
      "targets": [
        { "expr": "histogram_quantile(0.50, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$primary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P50", "refId": "A" },
        { "expr": "histogram_quantile(0.90, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$primary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P90", "refId": "B" },
        { "expr": "histogram_quantile(0.99, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$primary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P99", "refId": "C" }
      ],
      "title": "Primary: Request Duration",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "s" } },
      "gridPos": { "h": 4, "w": 12, "x": 12, "y": 7 },
      "id": 91,
      "options": { "legend": { "displayMode": "list", "showLegend": false } },
      "targets": [
        { "expr": "histogram_quantile(0.50, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$canary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P50", "refId": "A" },
        { "expr": "histogram_quantile(0.90, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$canary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P90", "refId": "B" },
        { "expr": "histogram_quantile(0.99, sum(irate(istio_request_duration_milliseconds_bucket{reporter=\"destination\",destination_workload=~\"$canary\", destination_workload_namespace=~\"$namespace\"}[2m])) by (le)) / 1000", "legendFormat": "P99", "refId": "C" }
      ],
      "title": "Canary: Request Duration",
      "type": "timeseries"
    }
  ],
  "refresh": "10s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["flagger", "istio", "canary"],
  "templating": {
    "list": [
      {
        "current": {},
        "hide": 0,
        "includeAll": false,
        "label": "Data Source",
        "multi": false,
        "name": "DS_PROMETHEUS",
        "options": [],
        "query": "prometheus",
        "queryValue": "",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "type": "datasource"
      },
      { "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" }, "definition": "label_values(istio_requests_total, destination_workload_namespace)", "name": "namespace", "label": "Namespace", "type": "query", "refresh": 1 },
      { "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" }, "definition": "label_values(istio_requests_total{destination_workload_namespace=~\"$namespace\"}, destination_workload)", "name": "primary", "label": "Primary", "type": "query", "refresh": 1, "regex": "/.*-primary/" },
      { "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" }, "definition": "label_values(istio_requests_total{destination_workload_namespace=~\"$namespace\"}, destination_workload)", "name": "canary", "label": "Canary", "type": "query", "refresh": 1, "regex": "/^(?!.*-primary$).*$/" }
    ]
  },
  "time": { "from": "now-5m", "to": "now" },
  "timezone": "",
  "title": "Istio Canary",
  "uid": "flagger-istio",
  "version": 1
}
