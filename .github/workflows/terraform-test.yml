name: 'Terraform Tests'

# This workflow runs linting, security scanning, and Terraform tests
# It is separate from the main Terraform workflow and can be run independently

on:
  push:
    branches:
      - main
      - 'feature/**'
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-test.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-test.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

env:
  TERRAFORM_VERSION: '1.6.0'
  TFLINT_VERSION: 'v0.50.3'
  ARM_USE_OIDC: true
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  # ============================================================
  # TFLint - Static Analysis
  # ============================================================
  lint:
    name: 'TFLint'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init --config=.tflint.hcl
        env:
          # Use GITHUB_TOKEN to avoid API rate limiting when downloading plugins
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TFLint on modules
        run: |
          echo "## TFLint Results" >> $GITHUB_STEP_SUMMARY
          for dir in modules/*/; do
            echo "### Module: $dir" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tflint --config=../.tflint.hcl --chdir="$dir" 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          done

      - name: Run TFLint on environment
        run: |
          echo "### Environment: dev" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tflint --config=../.tflint.hcl --chdir=environments/dev 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Checkov - Security Scanning
  # ============================================================
  security:
    name: 'Checkov Security'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          config_file: terraform/.checkov.yaml
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov

      - name: Upload Checkov Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: results.sarif
          retention-days: 14

  # ============================================================
  # Terraform Format Check
  # ============================================================
  format:
    name: 'Format Check'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          echo "## Terraform Format Check" >> $GITHUB_STEP_SUMMARY
          if terraform fmt -check -recursive -diff terraform; then
            echo "✅ All files are properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some files need formatting. Run 'terraform fmt -recursive terraform'" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================
  # Terraform Validate
  # ============================================================
  validate:
    name: 'Validate'
    runs-on: ubuntu-latest
    needs: [lint, security, format]
    defaults:
      run:
        working-directory: terraform/environments/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: |
          echo "## Terraform Validate" >> $GITHUB_STEP_SUMMARY
          if terraform validate -no-color; then
            echo "✅ Configuration is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Configuration validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================
  # Terraform Native Tests
  # ============================================================
  test:
    name: 'Terraform Tests'
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: terraform/environments/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # No Azure Login needed - tests use mock providers
      - name: Terraform Init
        run: terraform init -backend=false

      - name: Run Terraform Tests
        run: |
          echo "## Terraform Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform test 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # PR Comment with Results
  # ============================================================
  comment:
    name: 'PR Comment'
    runs-on: ubuntu-latest
    needs: [lint, security, format, validate, test]
    if: github.event_name == 'pull_request' && always()

    steps:
      - name: Post Results to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lintResult = '${{ needs.lint.result }}';
            const securityResult = '${{ needs.security.result }}';
            const formatResult = '${{ needs.format.result }}';
            const validateResult = '${{ needs.validate.result }}';
            const testResult = '${{ needs.test.result }}';
            
            const getEmoji = (result) => {
              switch(result) {
                case 'success': return '✅';
                case 'failure': return '❌';
                case 'skipped': return '⏭️';
                default: return '⚠️';
              }
            };
            
            const output = `## Terraform Test Results
            
            | Check | Status |
            |-------|--------|
            | TFLint | ${getEmoji(lintResult)} ${lintResult} |
            | Checkov Security | ${getEmoji(securityResult)} ${securityResult} |
            | Format Check | ${getEmoji(formatResult)} ${formatResult} |
            | Validate | ${getEmoji(validateResult)} ${validateResult} |
            | Terraform Tests | ${getEmoji(testResult)} ${testResult} |
            
            *Triggered by: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
